# TCP

## 头部

TCP 头部含有以下几个重要字段

1. Sequence number，这个序号保证了 TCP 传输的报文都是有序的，对端可以通过序号顺利的拼接报文
2. Acknowledgement Number，这个序号表示数据接收端期望接收的下一个字节的编号是多少，同时也表示上一个序号的数据已经收到。
3. Window Size,窗口大小，表示还能接收多少字节的数据，用于流量控制
4. 标识符：  
   URG=1：该字段为一标识本数据报的数据部分包含紧急信息，是一个高优先级的数据报文，此时紧急指针有效。紧急数据一定位于当前数据包数据部分的最前面，紧急指针标明了紧急数据的尾部。  
   ACK=1：该字段为一表示确认号字段有效。此外，TCP 还规定在连接建立后传送的所有报文段都必须把 ACK 置为一。  
   PSH=1：该字段为一表示接收端应该立即将数据 push 给应用层，而不是等到缓冲区满后再提交。  
   RST=1：该字段为一表示当前 TCP 连接出现严重问题，可能需要重新建立 TCP 连接，也可以用于拒绝非法的报文段和拒绝连接请求。  
   SYN=1：当 SYN=1，ACK=0 时，表示当前报文段是一个连接请求报文。当 SYN=1，ACK=1 时，表示当前报文段是一个同意建立连接的应答报文。  
   FIN=1：该字段为一表示此报文段是一个释放连接的请求报文。

## 状态机

状态机负责三次握手  
1.第一次握手客户端发送连接请求。该报文段中包含自身的数据通讯初始序号。进度 SYN-SENT 状态。  
2.第二次握手服务端收到请求后，如果同意连接就会发送一个应答，应答中也会包含自身的数据通信初始序号，然后进入 SYN-RECEIVED 状态  
3.第三次握手，客户端收到连接同意的应答后，还想服务端发送一个确认报文，然后进入 ESTABLISHED 状态，服务端收到这个应答后也进入 ESTABLISHED 状态，此时连接建立成功。

PS：第三次握手中可以包含数据，通过快速打开（TFO）技术就可以实现这一功能。其实只要涉及到握手的协议，都可以使用类似 TFO 的方式，客户端和服务端存储相同的 cookie，下次握手时发出 cookie 达到减少 RTT 的目的。

常考面试题：为什么 TCP 建立连接需要三次握手，明明两次就可以建立起连接？  
为了放置出现失效的连接请求报文段被服务端接收的情况，从而产生错误。A 端发送了连接请求，但是网络不好等待到了自己这边超时了，会重新发一个请求，然后关闭上一个请求的状态。之后服务端会因此一直处于等待资源传输状态，造成资源浪费

断开链接四次握手

1.  第一次握手，客户端发送连接释放请求（FIN）
2.  第二次握手，服务端收到请求后发送 ACK 包，然后进入 CLOSE_WAIT 状态，此时表明 A 到 B 的连接已经释放，不再接受 A 的数据。但是因为 TCP 双向的，所以 B 还能往 A 发送数据
3.  如果此时 B 还有数据没发完，会继续发完数据，然后向 A 发送连接释放请求（FIN），然后进入 LAST-ASK 状态  
    PS：通过延迟确认的技术（通常有时间限制，否则对方会误认为需要重传），可以将第二次和第三次握手合并，延迟 ACK 包的发送。
4.  A 收到释放请求后，向 B 发送确认应答，此时 A 进入 TIME-WAIT 状态。该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有 B 的重发请求的话，就进入 CLOSED 状态。当 B 收到确认应答后，也便进入 CLOSED 状态。  
    为什么 A 要进入 TIME-WAIT 状态，等待 2MSL 时间后才进入 CLOSED 状态？

为了保证 B 能收到 A 的确认应答。若 A 发完确认应答后直接进入 CLOSED 状态，如果确认应答因为网络问题一直没有到达，那么会造成 B 不能正常关闭。

## ARQ 协议

ARQ 协议也就是超时重传机制。通过确认和超时机制保证了数据的正确送达，ARQ 协议包含停止等待 ARQ 和连续 ARQ 两种协议。  
停止等待 ARQ：传输之后等待，超时了才重新发送  
连续 ARQ：发送端有一个发送窗口，持续发送窗口内的数据，在接收端返回了应答报文之后不再发送已经被接受的数据（用了累计确认）

## 滑动窗口

发送端窗口包含已发送但未收到应答的数据和可以发送但是未发送的数据。  
发送端窗口是由接收窗口剩余大小决定的。接收方会把当前接收窗口的剩余大小写入应答报文，发送端收到应答后根据该值和当前网络拥塞情况设置发送窗口的大小，所以发送窗口的大小是不断变化的。  
当发送端接收到应答报文后，会随之将窗口进行滑动  
滑动窗口是一个很重要的概念，它帮助 TCP 实现了流量控制的功能。接收方通过报文告知发送方还可以发送多少数据，从而保证接收方能够来得及接收数据，防止出现接收方带宽已满，但是发送方还一直发送数据的情况。
## Zero窗口  
在发送报文的过程中，可能会遇到对端出现零窗口的情况。在该情况下，发送端会停止发送数据，并启动 persistent timer 。该定时器会定时发送请求给对端，让对端告知窗口大小。在重试次数超过一定次数后，可能会中断 TCP 链接。  
## 拥塞处理  
作用与网络，防止过多的数据拥塞网络，避免出现网络负载过大的情况。  
拥塞处理包含了四个算法，分别为：慢开始、拥塞避免、快速重传、快速恢复  

# 总结
1. 建立连接需要三次握手，断开连接需要四次握手  
2. 滑动窗口解决了数据的丢包、顺序不对和流量控制问题  
3. 拥塞窗口实现了对流量的控制（网络），保证在全天候环境下最优化的传递数据  